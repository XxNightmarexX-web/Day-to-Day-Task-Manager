<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TaskFlow — Ultimate Task Manager (Firebase Auth)</title>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>

<style>
:root{
  --bg: #f6f8fb; --card:#fff; --muted:#6b7280; --accent:#4caf50; --accent2:#06b6d4;
  --danger:#ef4444; --glass: rgba(255,255,255,0.6); --radius:12px; --shadow:0 8px 22px rgba(8,15,30,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;color:#0f172a;background:linear-gradient(180deg,#eef2ff 0%, #f6f8fb 100%);}
body.dark{background:linear-gradient(180deg,#07101a 0%, #071526 100%); color:#e6eef6;}
.container{max-width:1200px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.splash{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;padding:26px;border-radius:18px;background:linear-gradient(135deg,#ffffff88,#f0f6ff88);box-shadow:var(--shadow);}
.logoCircle{width:86px;height:86px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;box-shadow:0 10px 30px rgba(6,95,70,0.15);}
.authWrap{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);min-width:280px;display:flex;flex-direction:column;gap:10px;}
.input{padding:10px;border-radius:8px;border:1px solid rgba(10,20,30,0.06);font-size:1rem}
.btn{padding:10px 12px;background:var(--accent);color:#fff;border:0;border-radius:8px;cursor:pointer;box-shadow:0 6px 18px rgba(76,175,80,0.14)}
.btn.ghost{background:transparent;border:1px solid rgba(10,20,30,0.06);color:var(--muted)}
.small{padding:8px 10px;border-radius:8px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logoSmall{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.controls{display:flex;align-items:center;gap:8px}
.topRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.progress{background:rgba(10,20,30,0.06);border-radius:999px;width:260px;height:12px;overflow:hidden}
.progressBar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .8s}
.board{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
.column{background:var(--card);padding:12px;border-radius:14px;box-shadow:var(--shadow);min-height:220px;display:flex;flex-direction:column;}
.colHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.cards{display:flex;flex-direction:column;gap:10px;flex:1;}
.card{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;box-shadow:0 6px 14px rgba(10,20,40,0.04);cursor:grab;transition:transform .12s,box-shadow .12s;position:relative;overflow:hidden}
body.dark .card{background:linear-gradient(180deg,#0f1724,#0b1420)}
.card:hover{transform:translateY(-6px)}
.cardTitle{font-weight:700;margin-bottom:6px}
.meta{font-size:0.82rem;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
.badge{padding:5px 8px;border-radius:999px;color:white;font-weight:700;font-size:0.78rem}
.badge.low{background:#16a34a}
.badge.medium{background:#f97316}
.badge.high{background:#ef4444}
.badge.cat{background:#0ea5e9}
.badge.rec{background:#7c3aed}
.cardFooter{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.cardActions{display:flex;gap:8px}
.modalWrap{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:flex;align-items:center;justify-content:center;z-index:1200}
.modal{background:var(--card);padding:12px;border-radius:12px;min-width:320px;max-width:720px;box-shadow:var(--shadow)}
.formRow{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.formRow input,.formRow select,.formRow textarea{padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);flex:1}
.formRow textarea{min-height:80px;resize:vertical}
.toast {position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;padding:12px 18px;border-radius:999px;box-shadow:var(--shadow);z-index:1500;display:flex;gap:12px;align-items:center}
.toast button{background:transparent;border:0;color:white;font-weight:700;padding:8px 10px;border-radius:8px;cursor:pointer}
.small-muted{font-size:.85rem;color:var(--muted)}
@media(max-width:980px){
  .board{grid-template-columns:1fr}
  .authWrap{flex-direction:column}
}
</style>
</head>
<body>

<div class="container" id="appRoot">

  <!-- Splash -->
  <div id="splash" class="splash" style="display:flex;flex-direction:column;align-items:center;gap:12px;">
    <div class="logoCircle">⏳</div>
    <div style="text-align:center">
      <h1 style="margin:0">TaskFlow</h1>
      <div style="color:var(--muted)">Stay ahead of your day — beautifully organized.</div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px">
      <button id="startBtn" class="btn">Get started</button>
      <button id="skipSplash" class="btn ghost">Skip</button>
    </div>
  </div>

  <!-- Auth area -->
  <div id="authArea" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logoSmall" style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">TF</div>
        <div>
          <div style="font-weight:700">TaskFlow</div>
          <div style="font-size:0.85rem;color:var(--muted)">Sign up or sign in with email</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:0.9rem;color:var(--muted)">Login UI</label>
        <select id="loginStyleSelect" class="input">
          <option value="minimal">Minimal</option>
          <option value="modern">Modern</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>

    <div class="authWrap">
      <div class="panel" id="loginPanel">
        <div class="authHeader"><strong>Sign in</strong><small class="small-muted">email</small></div>
        <input id="loginEmail" class="input" placeholder="Email" type="email" />
        <input id="loginPassword" class="input" placeholder="Password" type="password" />
        <div style="display:flex;gap:8px">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnGoSignup" class="btn ghost">Sign up</button>
        </div>
        <div id="loginInfo" style="margin-top:8px;font-size:0.9rem;color:var(--muted)"></div>
      </div>

      <div class="panel" id="signupPanel">
        <div class="authHeader"><strong>Create account</strong><small class="small-muted">email + verification</small></div>
        <input id="signupEmail" class="input" placeholder="Email" type="email" />
        <input id="signupPassword" class="input" placeholder="Password (min 6 chars)" type="password" />
        <input id="signupPassword2" class="input" placeholder="Confirm Password" type="password" />
        <div style="display:flex;gap:8px">
          <button id="btnSignup" class="btn">Create</button>
          <button id="btnGoLogin" class="btn ghost">Back</button>
        </div>

        <!-- verification UI -->
        <div id="verificationArea" style="margin-top:10px;display:none">
          <div style="font-size:0.9rem;color:var(--muted)">Verification required. A link has been sent to your email.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="resendCodeBtn" class="btn small">Resend Verification Email</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" style="display:none">
    <div class="header">
      <div class="brand" style="gap:10px">
        <div class="logoSmall" id="appLogo">TF</div>
        <div>
          <div class="title">TaskFlow</div>
          <div class="small-muted" id="userEmailDisplay"></div>
        </div>
      </div>

      <div class="controls">
        <input id="quickSearch" class="input" placeholder="Search tasks..." style="width:220px" />
        <button id="btnNewTask" class="btn small">+ New Task</button>
        <button id="btnSettings" class="btn ghost small">Settings</button>
        <button id="btnLogout" class="btn ghost small">Logout</button>
      </div>
    </div>

    <div class="topRow" style="margin-top:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:700">Progress</div>
        <div class="progress"><div id="progressFill" class="progressBar" style="width:0%"></div></div>
        <div id="progressPercent" style="font-weight:700">0%</div>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div style="min-width:220px" class="chartContainer"><canvas id="priorityChart"></canvas></div>
        <div style="min-width:220px" class="chartContainer"><canvas id="categoryChart"></canvas></div>
      </div>
    </div>

    <div class="board" id="board">
      <div class="column">
        <div class="colHead"><strong>To Do</strong><span id="countTodo" class="small-muted">0</span></div>
        <div id="todoList" class="cards"></div>
      </div>

      <div class="column">
        <div class="colHead"><strong>In Progress</strong><span id="countProg" class="small-muted">0</span></div>
        <div id="progList" class="cards"></div>
      </div>

      <div class="column">
        <div class="colHead"><strong>Completed</strong><span id="countDone" class="small-muted">0</span></div>
        <div id="doneList" class="cards"></div>
      </div>
    </div>

    <h3 style="margin-top:12px">Summary</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="chartContainer" style="flex:1;min-width:260px"><canvas id="weeklyChart"></canvas></div>
      <div class="chartContainer" style="flex:1;min-width:260px"><canvas id="monthlyChart"></canvas></div>
    </div>

    <div class="footer" style="margin-top:12px">
      <div>TaskFlow • Firebase Auth Demo</div>
      <div><small class="small-muted">Change Login & Dashboard styles anytime in Settings</small></div>
    </div>
  </div>

</div>

<!-- modal templates -->
<template id="taskModalTpl">
  <div class="modalWrap">
    <div class="modal">
      <h3 id="modalTitle">New Task</h3>
      <div class="formRow"><input id="t_title" class="input" placeholder="Task title (required)"/></div>
      <div class="formRow">
        <input id="t_date" type="date" class="input"/><input id="t_time" type="time" class="input"/>
        <input id="t_color" type="color" value="#4caf50" class="input" style="width:64px"/>
      </div>
      <div class="formRow">
        <select id="t_priority" class="input"><option>Low</option><option selected>Medium</option><option>High</option></select>
        <select id="t_category" class="input"><option>General</option><option>Work</option><option>Personal</option><option>Study</option></select>
        <select id="t_recurring" class="input"><option>None</option><option>Hourly</option><option>Daily</option><option>Weekly</option><option>Monthly</option><option>Yearly</option></select>
      </div>
      <div class="formRow"><textarea id="t_notes" placeholder="Notes or subtasks (one per line)"></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="t_cancel" class="btn ghost small">Cancel</button>
        <button id="t_save" class="btn small">Save Task</button>
      </div>
    </div>
  </div>
</template>

<template id="settingsTpl">
  <div class="modalWrap">
    <div class="modal">
      <h3>Settings</h3>
      <div class="formRow"><label>Dashboard Theme</label>
        <select id="themeSelect" class="input"><option value="light">Light</option><option value="dark">Dark</option><option value="vibrant">Vibrant</option><option value="glass">Glass</option></select>
      </div>
      <div class="formRow"><label>Login UI Style</label>
        <select id="loginUiSelect" class="input"><option value="minimal">Minimal</option><option value="modern">Modern</option><option value="dark">Dark</option></select>
      </div>

      <div class="formRow">
        <button id="exportTasksBtn" class="btn small">Export Tasks</button>
        <button id="importTasksBtn" class="btn ghost small">Import Tasks</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="formRow" style="display:flex;gap:8px">
        <button id="deleteAccountBtn" class="btn ghost small" style="background:#fee2e2;color:#b91c1c">Delete Account</button>
        <button id="closeSettingsBtn" class="btn small">Close</button>
      </div>
    </div>
  </div>
</template>

<!-- toast area & audio -->
<div id="toastArea" style="position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:2000"></div>
<audio id="alertSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

<script>
// Initialize Firebase (replace with your Firebase config)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* ============================================================================
   Utilities & local-storage keys
   ============================================================================ */
const TASKS_PREFIX = 'tf_tasks_v2_';   // per-user task store
const UIPREFS_KEY = 'tf_ui_prefs_v2';

function saveTasks(email, tasks) {
  localStorage.setItem(tasksKey(email), JSON.stringify(tasks));
}
function loadTasks(email) {
  return JSON.parse(localStorage.getItem(tasksKey(email)) || '[]');
}
function savePrefs(p) {
  localStorage.setItem(UIPREFS_KEY, JSON.stringify(p));
}
function loadPrefs() {
  return JSON.parse(localStorage.getItem(UIPREFS_KEY) || '{}');
}
function tasksKey(email) {
  return TASKS_PREFIX + btoa(email || '');
}

/* Simple toast */
function toast(msg, options = {}) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.innerHTML = `<div>${msg}</div>` + (options.undo ? `<button id="undoBtn">Undo</button>` : '');
  document.getElementById('toastArea').appendChild(el);
  if (options.undo && options.onUndo) document.getElementById('undoBtn').addEventListener('click', () => { options.onUndo(); el.remove(); });
  setTimeout(() => el.remove(), options.duration || 4000);
}

/* basic helper */
const $ = id => document.getElementById(id);

/* ============================================================================
   App state
   ============================================================================ */
let currentUser = null;
let prefs = loadPrefs();
if (!prefs.theme) prefs.theme = 'light';
if (!prefs.loginStyle) prefs.loginStyle = 'minimal';
savePrefs(prefs);

let tasks = [];
let charts = {};

/* ============================================================================
   UI: show/hide views
   ============================================================================ */
const splash = $('splash'), authArea = $('authArea'), mainApp = $('mainApp');
function showSplash() { splash.style.display = 'flex'; authArea.style.display = 'none'; mainApp.style.display = 'none'; }
function showAuth() { splash.style.display = 'none'; authArea.style.display = 'block'; mainApp.style.display = 'none'; applyLoginStyle(); }
function showMain() { splash.style.display = 'none'; authArea.style.display = 'none'; mainApp.style.display = 'block'; applyDashboardTheme(); }

/* Firebase auth state listener */
auth.onAuthStateChanged(user => {
  if (user && user.emailVerified) {
    currentUser = user.email;
    $('userEmailDisplay').textContent = currentUser;
    initializeAfterLogin();
    showMain();
    toast('Welcome back!');
  } else {
    currentUser = null;
    tasks = [];
    showSplash();
  }
});

/* ============================================================================
   Splash / auth wiring
   ============================================================================ */
$('startBtn').addEventListener('click', () => showAuth());
$('skipSplash').addEventListener('click', () => showAuth());

/* login style select */
$('loginStyleSelect').value = prefs.loginStyle;
$('loginStyleSelect').addEventListener('change', (e) => { prefs.loginStyle = e.target.value; savePrefs(prefs); applyLoginStyle(); });

function applyLoginStyle() {
  const style = prefs.loginStyle;
  const panels = document.querySelectorAll('#authArea .panel');
  if (style === 'minimal') { document.body.classList.remove('dark'); panels.forEach(p => { p.style.background = 'var(--card)'; p.style.boxShadow = 'var(--shadow)'; }); }
  else if (style === 'modern') { document.body.classList.remove('dark'); panels.forEach(p => { p.style.background = 'linear-gradient(180deg,#fff,#f3fbff)'; p.style.boxShadow = '0 12px 36px rgba(6,95,70,0.06)'; }); }
  else if (style === 'dark') { document.body.classList.add('dark'); panels.forEach(p => { p.style.background = '#0f1724'; p.style.boxShadow = '0 12px 36px rgba(0,0,0,0.6)'; }); }
}

/* ============================================================================
   Signup / Verification / Login / Logout
   ============================================================================ */
async function signupFlow() {
  const email = $('signupEmail').value.trim().toLowerCase();
  const pw = $('signupPassword').value;
  const pw2 = $('signupPassword2').value;
  if (!email || !pw) return toast('Email and password required');
  if (pw.length < 6) return toast('Password must be at least 6 characters');
  if (pw !== pw2) return toast('Passwords do not match');

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, pw);
    await userCredential.user.sendEmailVerification();
    $('verificationArea').style.display = 'block';
    toast('Verification email sent. Please check your inbox.');
    saveTasks(email, []); // Initialize empty tasks for new user
  } catch (error) {
    if (error.code === 'auth/email-already-in-use') {
      toast('Account already exists. Please log in.');
    } else {
      toast(`Error: ${error.message}`);
    }
  }
}

$('btnSignup').addEventListener('click', signupFlow);

/* Resend verification email */
$('resendCodeBtn').addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return toast('No pending signup found.');
  try {
    await user.sendEmailVerification();
    toast('Verification email resent.');
  } catch (error) {
    toast(`Error: ${error.message}`);
  }
});

/* Login */
$('btnLogin').addEventListener('click', async () => {
  const email = $('loginEmail').value.trim().toLowerCase();
  const pw = $('loginPassword').value;
  if (!email || !pw) return toast('Provide email and password');

  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, pw);
    if (!userCredential.user.emailVerified) {
      $('verificationArea').style.display = 'block';
      toast('Please verify your email. Check your inbox for the verification link.');
      await auth.signOut();
    }
  } catch (error) {
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      toast('Invalid email or password.');
    } else {
      toast(`Error: ${error.message}`);
    }
  }
});

/* Logout */
$('btnLogout').addEventListener('click', async () => {
  await auth.signOut();
  currentUser = null;
  tasks = [];
  showAuth();
  toast('Logged out.');
});

/* Navigation between auth panels */
$('btnGoSignup').addEventListener('click', () => { $('signupEmail').focus(); });
$('btnGoLogin').addEventListener('click', () => { $('loginEmail').focus(); });

/* ============================================================================
   After login: load tasks and init app features
   ============================================================================ */
function initializeAfterLogin() {
  if (!currentUser) return showAuth();
  tasks = loadTasks(currentUser).map(normalizeTask);
  applyDashboardTheme();
  renderAll();
  setInterval(checkDueTasks, 30 * 1000);
  setInterval(processRecurring, 60 * 1000);
}

/* Normalize task */
function normalizeTask(t) {
  return {
    id: t.id || ('id' + Math.random().toString(36).slice(2, 9)),
    text: t.text || 'Untitled',
    notes: t.notes || '',
    date: t.date || '',
    time: t.time || '',
    color: t.color || '#4caf50',
    priority: t.priority || 'Medium',
    category: t.category || 'General',
    recurring: t.recurring || 'None',
    subtasks: t.subtasks || [],
    completed: !!t.completed,
    added: t.added || new Date().toISOString(),
    alerted: !!t.alerted
  };
}

/* ============================================================================
   Task CRUD, render, drag-drop, reorder
   ============================================================================ */
const todoList = $('todoList'), progList = $('progList'), doneList = $('doneList');
const countTodo = $('countTodo'), countProg = $('countProg'), countDone = $('countDone');
const progressFill = $('progressFill'), progressPercent = $('progressPercent');

function renderAll() {
  todoList.innerHTML = ''; progList.innerHTML = ''; doneList.innerHTML = '';
  const q = $('quickSearch').value.trim().toLowerCase();
  let todoCount = 0, progCount = 0, doneCount = 0;
  tasks.forEach((t, i) => {
    if (q && !((t.text || '').toLowerCase().includes(q) || (t.notes || '').toLowerCase().includes(q) || (t.category || '').toLowerCase().includes(q))) return;
    const card = renderCard(t, i);
    if (t.completed) { doneList.appendChild(card); doneCount++; }
    else if (t.inProgress) { progList.appendChild(card); progCount++; }
    else { todoList.appendChild(card); todoCount++; }
  });
  countTodo.textContent = todoCount; countProg.textContent = progCount; countDone.textContent = doneCount;
  updateProgress();
  saveTasks(currentUser, tasks);
  renderCharts();
  renderSummary();
}

/* Create card element */
function renderCard(t, idx) {
  const el = document.createElement('div');
  el.className = 'card';
  el.dataset.index = idx;
  el.style.borderLeft = `6px solid ${t.color || '#4caf50'}`;
  el.innerHTML = `
    <div class="cardTitle">${escapeHtml(t.text)}</div>
    <div class="meta">
      <div class="badge ${t.priority.toLowerCase()}">${t.priority}</div>
      <div class="badge cat">${escapeHtml(t.category)}</div>
      ${t.recurring && t.recurring !== 'None' ? `<div class="badge rec">${t.recurring}</div>` : ''}
      ${t.date ? `<div style="font-size:.82rem;color:var(--muted)">${t.date} ${t.time || ''}</div>` : ''}
    </div>
    <div class="cardFooter">
      <div class="small-muted">${t.subtasks && t.subtasks.length ? (t.subtasks.filter(s => s.done).length + '/' + t.subtasks.length + ' subtasks') : ''}</div>
      <div class="cardActions">
        <button class="smallBtn" data-action="edit">Edit</button>
        <button class="smallBtn" data-action="toggle">${t.completed ? 'Undo' : 'Done'}</button>
        <button class="smallBtn" data-action="delete">Delete</button>
      </div>
    </div>
  `;
  el.querySelector('[data-action="delete"]').addEventListener('click', () => {
    const removed = tasks.splice(idx, 1)[0];
    renderAll();
    toast('Task deleted', { undo: true, onUndo: () => { tasks.splice(idx, 0, removed); renderAll(); } });
  });
  el.querySelector('[data-action="toggle"]').addEventListener('click', () => {
    tasks[idx].completed = !tasks[idx].completed;
    if (tasks[idx].completed && tasks[idx].recurring && tasks[idx].recurring !== 'None') {
      scheduleNextOccurrence(tasks[idx]);
      tasks[idx].completed = false;
    }
    renderAll();
  });
  el.querySelector('[data-action="edit"]').addEventListener('click', () => openTaskModal('edit', idx));
  return el;
}

/* Drag-and-drop using Sortable */
function initSortable() {
  const opts = { group: 'tasks', animation: 180, onEnd: onDragEnd };
  Sortable.create(todoList, opts);
  Sortable.create(progList, opts);
  Sortable.create(doneList, opts);
}
function onDragEnd(evt) {
  const all = [...todoList.children, ...progList.children, ...doneList.children];
  const newTasks = all.map(node => tasks[Number(node.dataset.index)]);
  newTasks.forEach((t, i) => {
    const parentId = all[i].parentElement.id;
    t.completed = (parentId === 'doneList');
    t.inProgress = (parentId === 'progList');
  });
  tasks = newTasks.map(normalizeTask);
  saveTasks(currentUser, tasks);
  renderAll();
}

/* Add new task button */
$('btnNewTask').addEventListener('click', () => openTaskModal('new'));

/* Open task modal (create/edit) */
function openTaskModal(mode, idx) {
  const tpl = document.getElementById('taskModalTpl');
  const node = tpl.content.cloneNode(true);
  document.body.appendChild(node);
  const modalWrap = document.querySelector('.modalWrap');
  const get = id => modalWrap.querySelector('#' + id);
  if (mode === 'edit') {
    const t = tasks[idx];
    get('modalTitle').textContent = 'Edit Task';
    get('t_title').value = t.text;
    get('t_date').value = t.date;
    get('t_time').value = t.time;
    get('t_color').value = t.color;
    get('t_priority').value = t.priority;
    get('t_category').value = t.category;
    get('t_recurring').value = t.recurring;
    get('t_notes').value = (t.subtasks || []).map(s => s.text).join('\n');
  } else {
    get('modalTitle').textContent = 'New Task';
  }
  get('t_cancel').addEventListener('click', () => modalWrap.remove());
  get('t_save').addEventListener('click', () => {
    const newTask = {
      text: get('t_title').value.trim() || 'Untitled',
      date: get('t_date').value,
      time: get('t_time').value,
      color: get('t_color').value || '#4caf50',
      priority: get('t_priority').value,
      category: get('t_category').value,
      recurring: get('t_recurring').value,
      subtasks: (get('t_notes').value || '').split('\n').map(s => s.trim()).filter(Boolean).map(s => ({ text: s, done: false })),
      completed: false,
      inProgress: false,
      added: new Date().toISOString(),
      id: 'id' + Math.random().toString(36).slice(2, 9)
    };
    if (mode === 'edit') {
      tasks[idx] = Object.assign(tasks[idx], newTask);
    } else {
      tasks.unshift(normalizeTask(newTask));
    }
    saveTasks(currentUser, tasks);
    renderAll();
    modalWrap.remove();
  });
}

/* Update progress */
function updateProgress() {
  if (tasks.length === 0) { progressFill.style.width = '0%'; $('progressPercent').textContent = '0%'; return; }
  const completed = tasks.filter(t => t.completed).length;
  const pct = Math.round((completed / tasks.length) * 100);
  progressFill.style.width = pct + '%';
  $('progressPercent').textContent = pct + '%';
}

/* ============================================================================
   Recurring logic
   ============================================================================ */
function scheduleNextOccurrence(task) {
  if (!task.date) return;
  const d = new Date(task.date + 'T' + (task.time || '00:00'));
  if (task.recurring === 'Hourly') d.setHours(d.getHours() + 1);
  else if (task.recurring === 'Daily') d.setDate(d.getDate() + 1);
  else if (task.recurring === 'Weekly') d.setDate(d.getDate() + 7);
  else if (task.recurring === 'Monthly') d.setMonth(d.getMonth() + 1);
  else if (task.recurring === 'Yearly') d.setFullYear(d.getFullYear() + 1);
  task.date = d.toISOString().split('T')[0];
  task.time = d.toTimeString().slice(0, 5);
}

/* Periodically process recurring tasks */
function processRecurring() {
  const now = new Date();
  tasks.forEach(t => {
    if (t.recurring && t.recurring !== 'None' && !t.completed) {
      if (t.date) {
        const due = new Date(t.date + 'T' + (t.time || '00:00'));
        while (due < now) {
          if (t.recurring === 'Hourly') due.setHours(due.getHours() + 1);
          else if (t.recurring === 'Daily') due.setDate(due.getDate() + 1);
          else if (t.recurring === 'Weekly') due.setDate(due.getDate() + 7);
          else if (t.recurring === 'Monthly') due.setMonth(due.getMonth() + 1);
          else if (t.recurring === 'Yearly') d.setFullYear(due.getFullYear() + 1);
          t.date = due.toISOString().split('T')[0];
          t.time = due.toTimeString().slice(0, 5);
        }
      }
    }
  });
  saveTasks(currentUser, tasks);
  renderAll();
}

/* ============================================================================
   Due task alerts
   ============================================================================ */
function checkDueTasks() {
  const now = new Date();
  tasks.forEach(t => {
    if (t.completed) return;
    if (t.date) {
      const dt = new Date(t.date + 'T' + (t.time || '00:00'));
      if (!t.alerted && now >= dt) {
        toast(`Due: ${t.text}`);
        document.getElementById('alertSound').play().catch(() => {});
        t.alerted = true;
        if (t.recurring && t.recurring !== 'None') {
          scheduleNextOccurrence(t);
          t.alerted = false;
        }
        saveTasks(currentUser, tasks);
        renderAll();
      }
    }
  });
}

/* ============================================================================
   Charts: priority/category and summary
   ============================================================================ */
function renderCharts() {
  const counts = { High: 0, Medium: 0, Low: 0 };
  const categories = {};
  tasks.forEach(t => { counts[t.priority] = (counts[t.priority] || 0) + 1; categories[t.category] = (categories[t.category] || 0) + 1; });
  try { if (charts.priority) charts.priority.destroy(); } catch (e) {}
  charts.priority = new Chart(document.getElementById('priorityChart'), { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#ef4444', '#f97316', '#16a34a'] }] } });
  try { if (charts.category) charts.category.destroy(); } catch (e) {}
  charts.category = new Chart(document.getElementById('categoryChart'), { type: 'doughnut', data: { labels: Object.keys(categories), datasets: [{ data: Object.values(categories), backgroundColor: Object.keys(categories).map((_, i) => `hsl(${i * 60 % 360} 70% 50%)`) }] } });
}

/* Summary charts */
function renderSummary() {
  const now = new Date();
  const weekly = Array(7).fill(0);
  const monthly = Array(31).fill(0);
  tasks.forEach(t => {
    if (t.completed && t.added) {
      const d = new Date(t.added);
      const diffDays = Math.floor((now - d) / (24 * 3600 * 1000));
      if (diffDays < 7) weekly[6 - diffDays] += 1;
      if (diffDays < 31) monthly[30 - diffDays] += 1;
    }
  });
  try { if (charts.weekly) charts.weekly.destroy(); } catch (e) {}
  charts.weekly = new Chart(document.getElementById('weeklyChart'), { type: 'bar', data: { labels: ['6d ago', '5d ago', '4d ago', '3d ago', '2d ago', 'Yesterday', 'Today'], datasets: [{ label: 'Completed', data: weekly, backgroundColor: '#4caf50' }] }, options: { scales: { y: { beginAtZero: true } } } });
  try { if (charts.monthly) charts.monthly.destroy(); } catch (e) {}
  charts.monthly = new Chart(document.getElementById('monthlyChart'), { type: 'bar', data: { labels: Array.from({ length: 31 }, (_, i) => i + 1), datasets: [{ label: 'Completed (past 31 days)', data: monthly, backgroundColor: '#06b6d4' }] }, options: { scales: { y: { beginAtZero: true } } } });
}

/* ============================================================================
   Settings modal, export/import, delete account
   ============================================================================ */
$('btnSettings').addEventListener('click', openSettings);
function openSettings() {
  const tpl = document.getElementById('settingsTpl');
  const node = tpl.content.cloneNode(true);
  document.body.appendChild(node);
  const modalWrap = document.querySelector('.modalWrap');
  const themeSelect = modalWrap.querySelector('#themeSelect');
  const loginUi = modalWrap.querySelector('#loginUiSelect');
  themeSelect.value = prefs.theme || 'light';
  loginUi.value = prefs.loginStyle || 'minimal';

  modalWrap.querySelector('#closeSettingsBtn').addEventListener('click', () => modalWrap.remove());
  modalWrap.querySelector('#themeSelect').addEventListener('change', (e) => { prefs.theme = e.target.value; savePrefs(prefs); applyDashboardTheme(); });
  modalWrap.querySelector('#loginUiSelect').addEventListener('change', (e) => { prefs.loginStyle = e.target.value; savePrefs(prefs); applyLoginStyle(); });

  modalWrap.querySelector('#exportTasksBtn').addEventListener('click', () => {
    const data = JSON.stringify(tasks, null, 2);
    const url = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
    const a = document.createElement('a'); a.href = url; a.download = 'tasks.json'; a.click();
  });
  modalWrap.querySelector('#importTasksBtn').addEventListener('click', () => modalWrap.querySelector('#importFile').click());
  modalWrap.querySelector('#importFile').addEventListener('change', (e) => {
    const f = e.target.files[0]; if (!f) return;
    const reader = new FileReader();
    reader.onload = () => { try { const arr = JSON.parse(reader.result); tasks = arr.map(normalizeTask); saveTasks(currentUser, tasks); renderAll(); toast('Imported tasks'); modalWrap.remove(); } catch (err) { toast('Invalid JSON'); } };
    reader.readAsText(f);
  });

  modalWrap.querySelector('#deleteAccountBtn').addEventListener('click', async () => {
    if (!confirm('Delete your account and all tasks? This is irreversible.')) return;
    try {
      await auth.currentUser.delete();
      localStorage.removeItem(tasksKey(currentUser));
      currentUser = null;
      tasks = [];
      showAuth();
      toast('Account deleted.');
    } catch (error) {
      toast(`Error: ${error.message}`);
    }
  });
}

/* Apply dashboard theme */
function applyDashboardTheme() {
  const theme = prefs.theme || 'light';
  document.body.classList.toggle('dark', theme === 'dark');
}

/* Helper escapeHtml */
function escapeHtml(s) { if (!s) return ''; return s.toString().replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

/* Quick search */
$('quickSearch').addEventListener('input', () => renderAll());

/* Initialize sortable */
document.addEventListener('DOMContentLoaded', () => {
  applyLoginStyle();
  initSortable();
});

</script>
</body>
</html>